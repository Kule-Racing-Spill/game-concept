var z=Object.defineProperty;var F=(n,b,t)=>b in n?z(n,b,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[b]=t;var a=(n,b,t)=>(F(n,typeof b!="symbol"?b+"":b,t),t);(function(){const b=document.createElement("link").relList;if(b&&b.supports&&b.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();const G=(n,b)=>{const t=n.indexOf(b);t>-1&&n.splice(t,1)};class h{constructor(b,t){a(this,"x");a(this,"y");this.x=b,this.y=t}plus(b){return new h(this.x+b.x,this.y+b.y)}minus(b){return new h(this.x-b.x,this.y-b.y)}multiply(b){return new h(this.x*b,this.y*b)}divide(b){return new h(this.x/b,this.y/b)}half(){return this.multiply(.5)}snap(b){return new h(Math.round(this.x/b)*b,Math.round(this.y/b)*b)}lengthTo(b){return Math.sqrt((this.x-b.x)**2+(this.y-b.y)**2)}isInside(b,t){return b.x<=this.x&&this.x<=b.x+t.x&&b.y<=this.y&&this.y<=b.y+t.y}moveTowards(b,t){return this.plus(this.direction(b).multiply(t))}direction(b){if(b.y===this.y&&b.x===this.x)return new h(0,0);const t=Math.atan2(b.y-this.y,b.x-this.x);return new h(Math.cos(t),Math.sin(t))}round(){return new h(Math.round(this.x),Math.round(this.y))}clamp(b,t){return new h(m(this.x,b.x,t.x),m(this.y,b.y,t.y))}equals(b){return this.x===b.x&&this.y==b.y}copy(){return new h(this.x,this.y)}}const m=(n,b,t)=>Math.max(Math.min(n,t),b);var P;(function(n){n[n.Left=0]="Left",n[n.Middle=1]="Middle",n[n.Right=2]="Right",n[n.BrowserBack=3]="BrowserBack",n[n.BrowserForward=4]="BrowserForward"})(P||(P={}));const x=new Set,v=new Set,y=new Set;document.addEventListener("keydown",n=>{x.add(n.key)});document.addEventListener("keyup",n=>{v.add(n.key)});const W=n=>{const b=new Set,t=new Set,e=new Set,i=(o,_)=>{b.forEach(d=>{e.add(d.button),o.forEach(l=>{l.onMousePress&&l.onMousePress(d,_)})}),b.clear(),t.forEach(d=>{e.delete(d.button),o.forEach(l=>{l.onMouseRelease&&l.onMouseRelease(d,_)})}),t.clear(),x.forEach(d=>{y.add(d),o.forEach(l=>{l.onKeyPress&&l.onKeyPress(d,_)})}),x.clear(),v.forEach(d=>{y.delete(d),o.forEach(l=>{l.onKeyRelease&&l.onKeyRelease(d,_)})}),v.clear()},s={mouse:{canvasPos:new h(0,0),worldPos:new h(0,0),button:o=>e.has(o)},key:o=>y.has(o),__handleInput:i},r=o=>{const _=n.scale??1;return new h((o.pageX-n.element.offsetLeft)/_,(o.pageY-n.element.offsetTop)/_)};document.addEventListener("mousedown",o=>{const _=r(o);b.add({button:o.button,canvasPos:_,worldPos:n.camera?n.camera.toWorldPosition(s.mouse.canvasPos):_})}),document.addEventListener("mouseup",o=>{const _=r(o);t.add({button:o.button,canvasPos:_,worldPos:n.camera?n.camera.toWorldPosition(s.mouse.canvasPos):_})});const c=o=>o.preventDefault();return document.addEventListener("mousemove",o=>{s.mouse.canvasPos=r(o),s.mouse.worldPos=n.camera?n.camera.toWorldPosition(s.mouse.canvasPos):s.mouse.canvasPos;const _=n.scale??1;s.mouse.canvasPos.isInside(new h(0,0),new h(n.element.width/_,n.element.height/_))?document.addEventListener("contextmenu",c):document.removeEventListener("contextmenu",c)}),s};class q{constructor(b){a(this,"__parentElement");a(this,"__canvasElement");a(this,"__ctx");a(this,"__scale",1);a(this,"camera");a(this,"drawImage",(b,t,e,i)=>{const s=Object.assign({imageSmoothingEnabled:!1},i);this.withStyleAndPos(s,r=>{b.image&&this.__ctx.drawImage(b.image,r.x,r.y,b.image.width*(e??1),b.image.height*(e??1))},t)});this.__parentElement=b,this.__canvasElement=document.createElement("canvas"),this.__canvasElement.classList.add("gameCanvas"),this.__parentElement.appendChild(this.__canvasElement),this.__ctx=this.__canvasElement.getContext("2d",{alpha:!1})}__getCameraPositionDelta(){var t,e;if(!((t=this.camera)!=null&&t.target))return new h(0,0);const b=this.camera.target.pos.minus(this.camera.posPrev);return this.camera.posPrev=(e=this.camera.target)==null?void 0:e.pos,b}setOptions(b){this.__canvasElement.width=b.width??this.__canvasElement.width,this.__canvasElement.height=b.height??this.__canvasElement.height,this.__scale=b.scale??this.__scale,b.scale&&this.__ctx.scale(b.scale,b.scale)}get element(){return this.__canvasElement}get scale(){return this.__scale}withStyle(b,t){this.__ctx.save(),b.strokeStyle!==void 0&&(this.__ctx.strokeStyle=b.strokeStyle),b.lineWidth!==void 0&&(this.__ctx.lineWidth=b.lineWidth),b.fillStyle!==void 0&&(this.__ctx.fillStyle=b.fillStyle),(b.font!==void 0||b.fontSize!==void 0)&&(this.__ctx.font=`${b.fontSize??8}px ${b.font??"arial"}`),b.imageSmoothingEnabled!=null&&(this.__ctx.imageSmoothingEnabled=b.imageSmoothingEnabled),t(),this.__ctx.restore()}withStyleAndPos(b,t,e){this.withStyle(b,()=>{this.camera&&!b.gui?t(this.camera.toCanvasPosition(e)):t(e)})}withStyleAndPositions(b,t,e){this.withStyle(b,()=>{this.camera&&!b.gui?t(e.map(i=>this.camera.toCanvasPosition(i))):t(e)})}drawRect(b,t,e){const i=Object.assign({fillStyle:"white"},e);this.withStyleAndPos(i,s=>{this.__ctx.fillStyle&&this.__ctx.fillRect(s.x,s.y,t.x,t.y),this.__ctx.strokeStyle&&this.__ctx.strokeRect(s.x,s.y,t.x,t.y)},b)}drawClear(){this.__ctx.clearRect(0,0,this.__canvasElement.width,this.__canvasElement.height)}drawPath(b,t){const e=Object.assign({strokeStyle:"white",lineWidth:1},t);this.withStyleAndPositions(e,i=>{this.__ctx.beginPath(),this.__ctx.moveTo(i[0].x,i[0].y);for(let s=0;s<i.length;s++)this.__ctx.lineTo(i[s].x,i[s].y);this.__ctx.stroke()},b)}drawLine(b,t,e,i){const s=b.copy(),r=t.copy(),c=Math.atan2(r.y-s.y,r.x-s.x);e.startOffset&&(s.x+=e.startOffset*Math.cos(c),s.y+=e.startOffset*Math.sin(c)),e.endOffset&&(r.x+=e.endOffset*Math.cos(c),r.y+=e.endOffset*Math.sin(c));const o=s.lengthTo(r);e.maxLength&&o>e.maxLength?(r.x=s.x+e.maxLength*Math.cos(c),r.y=s.y+e.maxLength*Math.sin(c)):e.minLength&&o<e.minLength&&(r.x=s.x+e.minLength*Math.cos(c),r.y=s.y+e.minLength*Math.sin(c)),this.drawPath([s,r],i)}drawText(b,t,e){const i=Object.assign({fillStyle:"white",font:"arial",fontSize:8},e);this.withStyleAndPos(i,s=>{this.__ctx.fillText(b,s.x,s.y+(i.fontSize??0))},t)}drawCircle(b,t,e){const i=Object.assign({fillStyle:"white"},e);this.withStyleAndPos(i,s=>{this.__ctx.beginPath(),this.__ctx.arc(s.x,s.y,b,0,2*Math.PI),this.__ctx.closePath(),this.__ctx.fillStyle&&this.__ctx.fill(),this.__ctx.strokeStyle&&this.__ctx.stroke()},t)}}class K{constructor(){a(this,"audioBuffers",new Map);a(this,"__context")}getContext(){return this.__context||(this.__context=new AudioContext),this.__context}async prefetch(b){const t=this.audioBuffers.get(b);if(t)return t;const e=await fetch(b).then(i=>i.arrayBuffer()).then(i=>this.getContext().decodeAudioData(i));return this.audioBuffers.set(b,e),e}async playAudioUrl(b){const t=this.audioBuffers.get(b)??await this.prefetch(b);this.playAudioBuffer(t)}async playAudioBuffer(b){const t=this.getContext(),e=t.createBufferSource();e.buffer=b,e.connect(t.destination),e.start()}}const E={width:480,height:320,scale:2,fps:60,zSort:!0,baseUrl:"./"};class H{constructor(b){a(this,"__gameDiv");a(this,"__assetsDiv");a(this,"__options",E);a(this,"__gameInstances",[]);a(this,"__canvas");a(this,"__t",0);a(this,"__input");a(this,"__currentFps",0);a(this,"__audioStore",new K);a(this,"beforeDraw");a(this,"afterDraw");a(this,"beforeStep");a(this,"afterStep");if(!b)throw new Error("Element passed to Game() is null!");if(!(b instanceof HTMLDivElement))throw new Error("Element passed to Game() is not an HTMLDivElement!");this.__gameDiv=b,this.__canvas=new q(this.__gameDiv),this.__assetsDiv=document.createElement("div"),this.__assetsDiv.hidden=!0,this.__gameDiv.appendChild(this.__assetsDiv),this.setOptions(E),this.__input=W(this.__canvas)}setOptions(b){this.__options={...this.__options,...b};const t=this.getCanvasSize().multiply(this.__options.scale);return this.__canvas.setOptions({width:t.x,height:t.y,scale:this.__options.scale}),this}get options(){return{...this.__options}}get canvas(){return this.__canvas}get currentFps(){return this.__currentFps}getCanvasSize(){return new h(this.__options.width,this.__options.height)}getInstances(b){return b?this.__gameInstances.filter(b):[...this.__gameInstances]}getInstancesOfClass(b){return this.getInstances(t=>t instanceof b)}__addObject(b){this.__gameInstances.push(b)}__removeObject(b){G(this.__gameInstances,b)}__addAssetElement(b){var t;(t=this.__assetsDiv)==null||t.appendChild(b)}play(){let b=0,t=0;const e=i=>{requestAnimationFrame(e);const s=i-b,r=1e3/this.__options.fps;s>=r&&(b=i-s%r,this.__currentFps=1e3/(i-t),t=i,this.__step())};e(0)}__maybeSort(){if(!this.__options.zSort)return;this.__gameInstances.some(t=>t.__changed)&&(this.__gameInstances.sort((t,e)=>t.__zIndex-e.__zIndex),this.__gameInstances.forEach(t=>t.__changed=!1))}getGameContext(){return{game:this,input:this.__input,audio:this.__audioStore,dtFactor:Math.round(this.__options.fps/this.currentFps)}}__step(){var e,i,s,r;const b={game:this,canvas:this.__canvas,input:this.__input,t:this.__t},t=this.getGameContext();this.__input.mouse.worldPos=this.__input.mouse.worldPos.plus(this.__canvas.__getCameraPositionDelta()),this.__maybeSort(),this.__input.__handleInput(this.__gameInstances,t),this.__canvas.drawClear(),(e=this.beforeDraw)==null||e.call(this,b),this.__gameInstances.forEach(c=>{var o;(o=c.draw)==null||o.call(c,b)}),(i=this.afterDraw)==null||i.call(this,b),(s=this.beforeStep)==null||s.call(this,t),this.__gameInstances.forEach(c=>{var o;(o=c.step)==null||o.call(c,t)}),(r=this.afterStep)==null||r.call(this,t),this.__t++}}class J{constructor(){a(this,"__changed",!0);a(this,"__zIndex",0);a(this,"__game");this.activate()}activate(b){var t;return b&&(this.deactivate(),this.__game=b),this.__game?(this.__game.__addObject(this),(t=this.onActivate)==null||t.call(this,this.__game.getGameContext()),this):this}deactivate(){var b;return this.__game?((b=this.onDeactivate)==null||b.call(this,this.__game.getGameContext()),this.__game.__removeObject(this),this):this}destruct(){var b;return this.deactivate(),this.__game?((b=this.onDestruct)==null||b.call(this,this.__game.getGameContext()),this):this}setZIndex(b){return this.__zIndex=b,this.__changed=!0,this}}class S extends J{constructor(t,e){super();a(this,"pos");this.pos=new h(t,e),this.setZIndex(e)}}const M=new Map;class N{}class f extends N{constructor(t,e){super();a(this,"__path");a(this,"__image");this.__path=t,e&&this.__load(e)}__load(t){const e=M.get(this.__path);e instanceof HTMLImageElement&&(this.__image=e);const i=new Image;i.src=this.__path,i.onload=()=>{M.set(this.__path,i),this.__image=i},t.__addAssetElement(i)}size(){var t,e;return new h(((t=this.__image)==null?void 0:t.width)??0,((e=this.__image)==null?void 0:e.height)??0)}get image(){return this.__image}}const p=new f("./mario_up.png"),I=new f("./mario_left.png"),L=new f("./mario_right.png"),C=3e-4,O=.02,k=10,A=1,U=.9,Z=.96;class $ extends S{constructor(t,e){super(t,e);a(this,"dir",0);a(this,"image",p);a(this,"speed",0);a(this,"rotateSpeed",0)}onActivate(t){p.__load(t.game),I.__load(t.game),L.__load(t.game)}step(t){for(t.input.key("w")&&(this.image=p,this.speed+=A),t.input.key("s")&&(this.image=p,this.speed-=A),this.speed=m(this.speed,-k,k),(this.speed>0&&!t.input.key("w")||this.speed<0&&!t.input.key("s"))&&(this.speed*=Z),this.pos.x+=Math.cos(this.dir)*this.speed,this.pos.y+=Math.sin(this.dir)*this.speed,t.input.key("a")&&(this.image=I,this.rotateSpeed-=C),t.input.key("d")&&(this.image=L,this.rotateSpeed+=C),this.rotateSpeed=m(this.rotateSpeed,-O,O),(this.rotateSpeed>0&&!t.input.key("d")||this.rotateSpeed<0&&!t.input.key("a"))&&(this.rotateSpeed*=U),this.dir+=this.rotateSpeed;this.dir<-Math.PI;)this.dir+=2*Math.PI;for(;this.dir>Math.PI;)this.dir-=2*Math.PI}}class X extends S{constructor(t,e){super(t,e);a(this,"target",new h(0,0));a(this,"image",T)}onActivate(t){this.randomizeTarget()}draw(t){}step(t){}randomizeTarget(){this.target=new h(D(-200,200),D(-200,200))}}const Y=(n,b)=>n+Math.random()*(b-n),D=(n,b)=>Math.round(Y(n,b));class Q extends S{constructor(){super(...arguments);a(this,"image",B)}}const j=`
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbb             bbbbbbbbbbbbbbbbbbbbbbbb                             bbbbbbb
bbbbbbb               bbbbbbbbbbbbbbbbbbbbbb    c           c     c      bbbbbbb
bbbbbbb                     bbbbbbbbbbbbbbbb                              bbbbbb
bbbbbbb                     bbbbbbbbbbbbbbbbbbbbbbbbbbbb                  bbbbbb
bbbbbbb       bbbbb               bbbbbbbbbbbbbbbbbbbbbbbbbbbbbb          bbbbbb
bbbbbbb       bbbbbbbbbbbb        bbbbbbbbbbbbbbbbbbbbbbbbbbbbbb          bbbbbb
bbbbbbb       bbb c bbbbbb        bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb       bbbbbb
bbbbbbb       bbb      cbb             bbbbbbbbbbbbbbbbbbbbbbbbbbbb       bbbbbb
bbbbbbb       bbb      bbbbbbbbb       bbbbbbbbbbbbbbbbbbbbbbbbbbbb       bbbbbb
bbbbbbb       bbbb c  bbbbbbbbbb       bbbbbbbbbbbbbbbbbbbbbbbbbbbb       bbbbbb
bbbbbbb       bbbbbbbbbbbbbbbbbb                   bbbbbbbbbbbbbbbb       bbbbbb
bbbbbbb       bbbbbbbbbbbbbbbbbb                   bbbbbbbbbbbbbbbb       bbbbbb
bbbbbbb            bbbbbbbbbbbbbbbbbb              bbbbbbbbbbbbbbbb       bbbbbb
bbbbbbb            bbbbbbbbbbbbbbbbbb                                     bbbbbb
bbbbbbb            bbbbbbbbbbbbbbbbbbbbbbbbbbbbbb                         bbbbbb
bbbbbbbbbbbb       bbbbbbbbbbbbbbbbbbbbbbbbbbbbbb                           bbbb
bbbbbbbbbbbb       bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb   bbbb
bbbbbbbbbbcb                             bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb   bbb
bbbbbbbbbbbb                                   bbbbbbbbbbbbbbbbbbbbbbbbbbb   bbb
bbbbbbbbbbbb   b                                                      bbbb   bbb
bbbbbbbbbb     bbbbbbbbbbbbbbbbbbb                                    bbb   bbbb
bbbbbbbbbb   bbbbbbbbbbbbbbbbbbbbb                                         bbbbb
bbbbbbbbb     bbbbbbbbbbbbbbbbbbbbbbbbbbb                                  bbbbb
bbbbbbbbb         bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb        bbbbb
bbbbb        c    bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb        bbbbb
bbbbb  c                                                                   bbbbb
bbbbb                                                                      bbbbb
bbbbbbbbb       c                                                     bbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
`,g=new H(document.querySelector("#app")),T=new f("./moo.png");T.__load(g);const B=new f("./bush.png");B.__load(g);const u=new $(0,0),w=[u];j.split(`
`).forEach((n,b)=>n.split("").forEach((t,e)=>{let i;const s=e*32,r=b*32;switch(t){case"b":i=new Q(s,r);break;case"c":i=new X(s,r);break}i&&w.push(i)}));w.forEach(n=>n.activate(g));const R=256;g.beforeDraw=n=>{const b=n.game.getCanvasSize(),t=b.y/3;n.canvas.drawRect(new h(0,0),new h(b.x,t+1),{fillStyle:"blue"}),n.canvas.drawRect(new h(0,t-1),new h(b.x,b.y),{fillStyle:"green"});const e=u.pos.minus(new h(R*Math.cos(u.dir),R*Math.sin(u.dir)));w.sort((i,s)=>e.lengthTo(s.pos)-e.lengthTo(i.pos)),w.forEach(i=>{let s=Math.atan2(i.pos.y-e.y,i.pos.x-e.x)-u.dir;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;if(!(-Math.PI/2<s&&s<Math.PI/2))return;const r=e.lengthTo(i.pos),c=m(100/Math.pow(r,.8),.01,2),o=new h(b.x/2-16,b.y),_=new h(32*Math.pow(r,.4)*Math.cos(s-Math.PI/2),16*Math.pow(r,.3)*Math.sin(s-Math.PI/2));n.canvas.drawImage(i.image,o.plus(_),c)})};g.play();
