var D=Object.defineProperty;var A=(a,t,e)=>t in a?D(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var h=(a,t,e)=>(A(a,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=e(n);fetch(n.href,i)}})();const k=(a,t)=>{const e=a.indexOf(t);e>-1&&a.splice(e,1)};class c{constructor(t,e){h(this,"x");h(this,"y");this.x=t,this.y=e}plus(t){return new c(this.x+t.x,this.y+t.y)}minus(t){return new c(this.x-t.x,this.y-t.y)}multiply(t){return new c(this.x*t,this.y*t)}divide(t){return new c(this.x/t,this.y/t)}half(){return this.multiply(.5)}snap(t){return new c(Math.round(this.x/t)*t,Math.round(this.y/t)*t)}lengthTo(t){return Math.sqrt((this.x-t.x)**2+(this.y-t.y)**2)}isInside(t,e){return t.x<=this.x&&this.x<=t.x+e.x&&t.y<=this.y&&this.y<=t.y+e.y}moveTowards(t,e){return this.plus(this.direction(t).multiply(e))}direction(t){if(t.y===this.y&&t.x===this.x)return new c(0,0);const e=Math.atan2(t.y-this.y,t.x-this.x);return new c(Math.cos(e),Math.sin(e))}round(){return new c(Math.round(this.x),Math.round(this.y))}clamp(t,e){return new c(x(this.x,t.x,e.x),x(this.y,t.y,e.y))}equals(t){return this.x===t.x&&this.y==t.y}copy(){return new c(this.x,this.y)}}const x=(a,t,e)=>Math.max(Math.min(a,e),t);var P;(function(a){a[a.Left=0]="Left",a[a.Middle=1]="Middle",a[a.Right=2]="Right",a[a.BrowserBack=3]="BrowserBack",a[a.BrowserForward=4]="BrowserForward"})(P||(P={}));const w=new Set,v=new Set,p=new Set;document.addEventListener("keydown",a=>{w.add(a.key)});document.addEventListener("keyup",a=>{v.add(a.key)});const T=a=>{const t=new Set,e=new Set,s=new Set,n=(r,d)=>{t.forEach(l=>{s.add(l.button),r.forEach(u=>{u.onMousePress&&u.onMousePress(l,d)})}),t.clear(),e.forEach(l=>{s.delete(l.button),r.forEach(u=>{u.onMouseRelease&&u.onMouseRelease(l,d)})}),e.clear(),w.forEach(l=>{p.add(l),r.forEach(u=>{u.onKeyPress&&u.onKeyPress(l,d)})}),w.clear(),v.forEach(l=>{p.delete(l),r.forEach(u=>{u.onKeyRelease&&u.onKeyRelease(l,d)})}),v.clear()},i={mouse:{canvasPos:new c(0,0),worldPos:new c(0,0),button:r=>s.has(r)},key:r=>p.has(r),__handleInput:n},o=r=>{const d=a.scale??1;return new c((r.pageX-a.element.offsetLeft)/d,(r.pageY-a.element.offsetTop)/d)};document.addEventListener("mousedown",r=>{const d=o(r);t.add({button:r.button,canvasPos:d,worldPos:a.camera?a.camera.toWorldPosition(i.mouse.canvasPos):d})}),document.addEventListener("mouseup",r=>{const d=o(r);e.add({button:r.button,canvasPos:d,worldPos:a.camera?a.camera.toWorldPosition(i.mouse.canvasPos):d})});const _=r=>r.preventDefault();return document.addEventListener("mousemove",r=>{i.mouse.canvasPos=o(r),i.mouse.worldPos=a.camera?a.camera.toWorldPosition(i.mouse.canvasPos):i.mouse.canvasPos;const d=a.scale??1;i.mouse.canvasPos.isInside(new c(0,0),new c(a.element.width/d,a.element.height/d))?document.addEventListener("contextmenu",_):document.removeEventListener("contextmenu",_)}),i};class z{constructor(t){h(this,"__parentElement");h(this,"__canvasElement");h(this,"__ctx");h(this,"__scale",1);h(this,"camera");h(this,"drawImage",(t,e,s,n)=>{const i=Object.assign({imageSmoothingEnabled:!1},n);this.withStyleAndPos(i,o=>{t.image&&this.__ctx.drawImage(t.image,o.x,o.y,t.image.width*(s??1),t.image.height*(s??1))},e)});this.__parentElement=t,this.__canvasElement=document.createElement("canvas"),this.__canvasElement.classList.add("gameCanvas"),this.__parentElement.appendChild(this.__canvasElement),this.__ctx=this.__canvasElement.getContext("2d",{alpha:!1})}__getCameraPositionDelta(){var e,s;if(!((e=this.camera)!=null&&e.target))return new c(0,0);const t=this.camera.target.pos.minus(this.camera.posPrev);return this.camera.posPrev=(s=this.camera.target)==null?void 0:s.pos,t}setOptions(t){this.__canvasElement.width=t.width??this.__canvasElement.width,this.__canvasElement.height=t.height??this.__canvasElement.height,this.__scale=t.scale??this.__scale,t.scale&&this.__ctx.scale(t.scale,t.scale)}get element(){return this.__canvasElement}get scale(){return this.__scale}withStyle(t,e){this.__ctx.save(),t.strokeStyle!==void 0&&(this.__ctx.strokeStyle=t.strokeStyle),t.lineWidth!==void 0&&(this.__ctx.lineWidth=t.lineWidth),t.fillStyle!==void 0&&(this.__ctx.fillStyle=t.fillStyle),(t.font!==void 0||t.fontSize!==void 0)&&(this.__ctx.font=`${t.fontSize??8}px ${t.font??"arial"}`),t.imageSmoothingEnabled!=null&&(this.__ctx.imageSmoothingEnabled=t.imageSmoothingEnabled),e(),this.__ctx.restore()}withStyleAndPos(t,e,s){this.withStyle(t,()=>{this.camera&&!t.gui?e(this.camera.toCanvasPosition(s)):e(s)})}withStyleAndPositions(t,e,s){this.withStyle(t,()=>{this.camera&&!t.gui?e(s.map(n=>this.camera.toCanvasPosition(n))):e(s)})}drawRect(t,e,s){const n=Object.assign({fillStyle:"white"},s);this.withStyleAndPos(n,i=>{this.__ctx.fillStyle&&this.__ctx.fillRect(i.x,i.y,e.x,e.y),this.__ctx.strokeStyle&&this.__ctx.strokeRect(i.x,i.y,e.x,e.y)},t)}drawClear(){this.__ctx.clearRect(0,0,this.__canvasElement.width,this.__canvasElement.height)}drawPath(t,e){const s=Object.assign({strokeStyle:"white",lineWidth:1},e);this.withStyleAndPositions(s,n=>{this.__ctx.beginPath(),this.__ctx.moveTo(n[0].x,n[0].y);for(let i=0;i<n.length;i++)this.__ctx.lineTo(n[i].x,n[i].y);this.__ctx.stroke()},t)}drawLine(t,e,s,n){const i=t.copy(),o=e.copy(),_=Math.atan2(o.y-i.y,o.x-i.x);s.startOffset&&(i.x+=s.startOffset*Math.cos(_),i.y+=s.startOffset*Math.sin(_)),s.endOffset&&(o.x+=s.endOffset*Math.cos(_),o.y+=s.endOffset*Math.sin(_));const r=i.lengthTo(o);s.maxLength&&r>s.maxLength?(o.x=i.x+s.maxLength*Math.cos(_),o.y=i.y+s.maxLength*Math.sin(_)):s.minLength&&r<s.minLength&&(o.x=i.x+s.minLength*Math.cos(_),o.y=i.y+s.minLength*Math.sin(_)),this.drawPath([i,o],n)}drawText(t,e,s){const n=Object.assign({fillStyle:"white",font:"arial",fontSize:8},s);this.withStyleAndPos(n,i=>{this.__ctx.fillText(t,i.x,i.y+(n.fontSize??0))},e)}drawCircle(t,e,s){const n=Object.assign({fillStyle:"white"},s);this.withStyleAndPos(n,i=>{this.__ctx.beginPath(),this.__ctx.arc(i.x,i.y,t,0,2*Math.PI),this.__ctx.closePath(),this.__ctx.fillStyle&&this.__ctx.fill(),this.__ctx.strokeStyle&&this.__ctx.stroke()},e)}}class B{constructor(){h(this,"audioBuffers",new Map);h(this,"__context")}getContext(){return this.__context||(this.__context=new AudioContext),this.__context}async prefetch(t){const e=this.audioBuffers.get(t);if(e)return e;const s=await fetch(t).then(n=>n.arrayBuffer()).then(n=>this.getContext().decodeAudioData(n));return this.audioBuffers.set(t,s),s}async playAudioUrl(t){const e=this.audioBuffers.get(t)??await this.prefetch(t);this.playAudioBuffer(e)}async playAudioBuffer(t){const e=this.getContext(),s=e.createBufferSource();s.buffer=t,s.connect(e.destination),s.start()}}const S={width:480,height:320,scale:2,fps:60,zSort:!0,baseUrl:"./"};class F{constructor(t){h(this,"__gameDiv");h(this,"__assetsDiv");h(this,"__options",S);h(this,"__gameInstances",[]);h(this,"__canvas");h(this,"__t",0);h(this,"__input");h(this,"__currentFps",0);h(this,"__audioStore",new B);h(this,"beforeDraw");h(this,"afterDraw");h(this,"beforeStep");h(this,"afterStep");if(!t)throw new Error("Element passed to Game() is null!");if(!(t instanceof HTMLDivElement))throw new Error("Element passed to Game() is not an HTMLDivElement!");this.__gameDiv=t,this.__canvas=new z(this.__gameDiv),this.__assetsDiv=document.createElement("div"),this.__assetsDiv.hidden=!0,this.__gameDiv.appendChild(this.__assetsDiv),this.setOptions(S),this.__input=T(this.__canvas)}setOptions(t){this.__options={...this.__options,...t};const e=this.getCanvasSize().multiply(this.__options.scale);return this.__canvas.setOptions({width:e.x,height:e.y,scale:this.__options.scale}),this}get options(){return{...this.__options}}get canvas(){return this.__canvas}get currentFps(){return this.__currentFps}getCanvasSize(){return new c(this.__options.width,this.__options.height)}getInstances(t){return t?this.__gameInstances.filter(t):[...this.__gameInstances]}getInstancesOfClass(t){return this.getInstances(e=>e instanceof t)}__addObject(t){this.__gameInstances.push(t)}__removeObject(t){k(this.__gameInstances,t)}__addAssetElement(t){var e;(e=this.__assetsDiv)==null||e.appendChild(t)}play(){let t=0,e=0;const s=n=>{requestAnimationFrame(s);const i=n-t,o=1e3/this.__options.fps;i>=o&&(t=n-i%o,this.__currentFps=1e3/(n-e),e=n,this.__step())};s(0)}__maybeSort(){if(!this.__options.zSort)return;this.__gameInstances.some(e=>e.__changed)&&(this.__gameInstances.sort((e,s)=>e.__zIndex-s.__zIndex),this.__gameInstances.forEach(e=>e.__changed=!1))}getGameContext(){return{game:this,input:this.__input,audio:this.__audioStore,dtFactor:Math.round(this.__options.fps/this.currentFps)}}__step(){var s,n,i,o;const t={game:this,canvas:this.__canvas,input:this.__input,t:this.__t},e=this.getGameContext();this.__input.mouse.worldPos=this.__input.mouse.worldPos.plus(this.__canvas.__getCameraPositionDelta()),this.__maybeSort(),this.__input.__handleInput(this.__gameInstances,e),this.__canvas.drawClear(),(s=this.beforeDraw)==null||s.call(this,t),this.__gameInstances.forEach(_=>{var r;(r=_.draw)==null||r.call(_,t)}),(n=this.afterDraw)==null||n.call(this,t),(i=this.beforeStep)==null||i.call(this,e),this.__gameInstances.forEach(_=>{var r;(r=_.step)==null||r.call(_,e)}),(o=this.afterStep)==null||o.call(this,e),this.__t++}}class R{constructor(){h(this,"__changed",!0);h(this,"__zIndex",0);h(this,"__game");this.activate()}activate(t){var e;return t&&(this.deactivate(),this.__game=t),this.__game?(this.__game.__addObject(this),(e=this.onActivate)==null||e.call(this,this.__game.getGameContext()),this):this}deactivate(){var t;return this.__game?((t=this.onDeactivate)==null||t.call(this,this.__game.getGameContext()),this.__game.__removeObject(this),this):this}destruct(){var t;return this.deactivate(),this.__game?((t=this.onDestruct)==null||t.call(this,this.__game.getGameContext()),this):this}setZIndex(t){return this.__zIndex=t,this.__changed=!0,this}}class M extends R{constructor(e,s){super();h(this,"pos");this.pos=new c(e,s),this.setZIndex(s)}}const E=new Map;class G{}class I extends G{constructor(e,s){super();h(this,"__path");h(this,"__image");this.__path=e,s&&this.__load(s)}__load(e){const s=E.get(this.__path);s instanceof HTMLImageElement&&(this.__image=s);const n=new Image;n.src=this.__path,n.onload=()=>{E.set(this.__path,n),this.__image=n},e.__addAssetElement(n)}size(){var e,s;return new c(((e=this.__image)==null?void 0:e.width)??0,((s=this.__image)==null?void 0:s.height)??0)}get image(){return this.__image}}class L extends M{constructor(e,s){super(e,s);h(this,"dir",-Math.PI/2)}step(e){e.input.key("a")&&(this.dir-=.03),e.input.key("d")&&(this.dir+=.03),this.dir=this.dir%(2*Math.PI);const s=3;e.input.key("w")&&(this.pos.x+=Math.cos(this.dir)*s,this.pos.y+=Math.sin(this.dir)*s),e.input.key("s")&&(this.pos.x+=Math.cos(this.dir)*-s,this.pos.y+=Math.sin(this.dir)*-s)}}class C extends M{constructor(e,s){super(e,s);h(this,"target",new c(0,0))}onActivate(e){this.randomizeTarget()}step(e){}randomizeTarget(){this.target=new c(g(-200,200),g(-200,200))}}const W=(a,t)=>a+Math.random()*(t-a),g=(a,t)=>Math.round(W(a,t)),f=new F(document.querySelector("#app")),O=new I("./player.png"),b=new I("./enemy.png");O.__load(f);b.__load(f);const m=new L(0,0),y=Array(100).fill(null).map(()=>new C(g(-200,200),g(-200,200)));y.push(m);y.forEach(a=>a.activate(f));f.beforeDraw=a=>{const t=a.game.getCanvasSize(),e=128,s=m.pos.minus(new c(e*Math.cos(m.dir),e*Math.sin(m.dir)));y.sort((n,i)=>s.lengthTo(i.pos)-s.lengthTo(n.pos)),y.forEach(n=>{let i=null;if(n instanceof L&&(i=O),n instanceof C&&(i=b),!i)return;const o=s.direction(n.pos),_=Math.atan2(o.y,o.x),r=s.lengthTo(n.pos),d=x(25/Math.pow(r,.6),.1,3),l=new c(t.x/2-16+r*Math.cos(_-m.dir-Math.PI/2),t.y+r*Math.sin(_-m.dir-Math.PI/2));l.y<t.y&&(l.y=t.y-Math.pow(Math.abs(t.y-l.y),.75)),a.canvas.drawImage(i,l,d)})};f.play();
